# AWS X-Ray

- AWS X-Ray is an AWS service that allows you to detect, analyze, and optimize performance issues with your AWS Lambda applications

- X-Ray collects metadata from the Lambda service and **any upstream or downstream services that make up your application**
	- X-Ray uses this metadata to generate a detailed service graph that illustrates performance bottlenecks, latency spikes, and other issues that impact the performance of your Lambda application.

- AWS X-Ray service can be integrated against using either the AWS SDK, the AWS CLI, or other third-party provided clients

#### Components
- Segment
	- Provides the name of the compute resources running your application logic, details about the request sent by your application
- Subsegment
	- Contains details about a call to an external component, such as AWS services (`aws` for AWS SDK calls), HTTP APIs (`remote` for downstream calls), or databases
	- Represent the application's view of downstream calls as a client
	- If the downstream services are not instrumented with X-Ray
		- X-Ray uses the subsegments to generate **inferred segments and downstream nodes** on the service map
		- This allows you to see the downstream dependencies, even if they don't support tracing
	- If the downstream services are instrumented with X-Ray
		- The segments sent by the downstream services **will replace the inferred segments generated from the upstream services' subsegments**
- Service graph
	- A JSON document that contains information about the services and resources that make up your application
	- Generated from the data sent by the application. Each AWS resource that sends data to X-Ray appears as a service in the graph
	- Service graph data is retained for 30 days
- Service map
	- Visualization found in the X-Ray service console, generated from the service graph
	- Provides a view of connections between services and your application and aggregated data for each service, including average latency and failure rates
	- Within the service map, the health of each node is represented by coloring on the ratio of successful calls to errors and faults
- Edge
- Trace
	- A trace ID tracks the path of a request through your application
	- A trace collects all the segments generated by a single request. That request is typically an HTTP GET or POST request that travels through a load balancer, hits your application code, and generates downstream calls to other AWS services or external web APIs
	- **The first supported service that the HTTP request interacts with adds a trace ID header to the request**, and propagates it downstream to track the latency, disposition, and other request data
- Group
	- A collection of traces as defined by a filter expression
	- Groups are identified by their name or ARN, and contains a filter expression
- Annotation
	- Key-value pairs that are indexed for use with filter expressions
	- Use annotations to record data that you want to use to group traces in the console, or when calling the GetTraceSummaries API
	- X-Ray indexes up to 50 annotations per trace
- Metadata
	- Key-value pairs with values of any type, including objects and lists, but that are not indexed
	- Use metadata to record data you want to store in the trace but donâ€™t need to use for searching traces, as it is not indexed
	- You can view annotations and metadata in the segment or subsegment details in the X-Ray console
- [[X-Ray SDK]]
- X-Ray API
	- Uploads **segment documents**, NOT trace segment
	- Trace segment: JSON representation of a request that your application serves
- [[X-Ray daemon]]


#### How it works 

![[X-Ray Architecture.png]]
![[X-Ray Flow.png]]

- Your application sends data about the work that it does in the form of segments
	- A segment provides the resource name, request, and response details and details about the job done
	- For example, when an HTTP request arrives at your application, the following segment data may be recorded. The host, including host name, alias and/or IP address. The request, including HTTP method, client address, path, and/or user agent. The response, including status and content. The work done, including start and end times and other called upon subsegments. Subsegments are used to record downstream calls from the point of view of the service that calls it. X-Ray uses subsegments to identify downstream services that do not send segments and create interest for them on the service graph
- Traces are formed by correlating segments using a unique trace ID
	- For example, when a client initiates a new request to your application, the request is tagged with a unique trace ID. As the service makes its way downstream through further services in your application, the services relay information regarding the request back to X-Ray using the same unique trace ID
- Annotations are used to add further business meaning to your tracing data
	- You add annotations by calling the appropriate method within the X-Ray SDK
- Add Metadata 
- Use filters to remove noises and quickly navigate and pinpoint hotspots within your distributed application
	- You can filter against attributes of the trace data or annotations
	
![[X-Ray Filter Expression.png]]

#### [[Instrumentation]]

#### Performance
- Sampling rules
	- To ensure that your tracing remains efficient while still providing a representative sample of the request that flow through your application, AWS X-Ray allows you to configure and customize a sampling rate which then governs the rate at which the trace data is collected

![[X-Ray Sampling Rule.png]]


#### Timing
-	Trace data sent to X-Ray is generally available for retrieval and filtering within 30 seconds of it being received by the service
-	X-Ray stores trace data for the last 30 days. This enables you to query trace data going back 30 days

#### Guide
- https://tutorialsdojo.com/aws-x-ray/
- https://tutorialsdojo.com/instrumenting-your-application-with-aws-x-ray/